import React, { useState, useEffect } from "react";
import { Auth0Provider, useAuth0 } from "@auth0/auth0-react";
import axios from "axios";
import { Outlet } from "react-router-dom";
import SideNav from "./layouts/SideNav";

const Tweet = () => {
    const [isTweetPostVisible, setIsTweetPostVisible] = useState(false);
  const { isAuthenticated, user } = useAuth0();
  const [profileData, setProfileData] = useState(null);

    const handleProfile = async () => {
      try {
        const response = await axios.post("/api/profile", {
          username: user.name,
          avatar: user.picture, // Include the avatar from Auth0
        });
        console.log(response.data.message);
        await addProfile();
      } catch (error) {
        console.error("Error creating profile:", error);
      }
    };

    const addProfile = async () => {
      try {
        const response = await fetch(
          `/api/profile?username=${user.name || user.sub}`,
          {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
            },
          }
        );

        if (response.ok) {
          const profileData = await response.json();

          if (profileData.username === user.name) {
            setProfileData(profileData);
            console.log("Profile ID:", profileData._id);
            console.log("Profile added successfully");
          } else {
            console.error("Profile username does not match Auth0 user name");
          }
        } else {
          console.error("Failed to add profile");
          // Throw an error to trigger the catch block
          throw new Error("Failed to add profile");
        }
      } catch (error) {
        console.error("Error:", error);
        // If an error occurs, run handleProfile
        await handleProfile();
      }
    };
    
      const handleTweetButtonClick = () => {
        setIsTweetPostVisible(!isTweetPostVisible);
      };

      const handleSubscribeClick = () => {
        alert("feature coming soon!");
  };
    useEffect(() => {
      if (isAuthenticated) {
        addProfile();
      }
    }, [isAuthenticated, user]);
    return (
      <div className="container">
        <SideNav
          profileId={profileData ? profileData._id : null}
          onTweetButtonClick={handleTweetButtonClick}
          onSomeClick={handleSubscribeClick}
        />
        <Outlet />
      </div>
    );
};

export default Tweet;
